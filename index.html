<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Environmental Survey Form</title>
  <!-- Firebase SDKs where the data collected from the surveys is stored. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- The following links is where the databases are stored -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <!-- The following code is what helps with the styling of the webpage -->
  <style>
    body {
      background-color: #05c46b;
      font-family: Verdana;
      text-align: center;
    }
    .form-step {
      display: none;
    }
    .form-step.active {
      display: block;
      background-color: #fff;
      max-width: 500px;
      margin: 50px auto;
      padding: 30px 20px;
      box-shadow: 2px 5px 10px rgba(0, 0, 0, 0.5);
    }
    .form-control {
      text-align: left;
      margin-bottom: 25px;
    }
    .form-control label {
      display: block;
      margin-bottom: 10px;
    }
    .form-control input[type="radio"] {
      display: inline-block;
      width: auto;
      margin-right: 10px;
    }
    button {
      background-color: #05c46b;
      border: 1px solid #777;
      border-radius: 2px;
      font-family: inherit;
      font-size: 21px;
      display: block;
      width: 100%;
      margin-top: 30px;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <!-- Main heading for the page -->
  <h1>Environmental Survey Form</h1>
  <!-- This is what triggers the survey questions to appear-->
  <form id="form"></form> <!--Questions will be displayed here r-->
  <canvas id="resultsChart" width="400" height="400" style="display:none; margin: 0 auto;"></canvas> <!-- After all questions are answered, this canvas isd will show the pie chart results in a 400x400 format-->

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB3LGXpqkKBctF67b-I6SznLwHL-VBoTBs",
      authDomain: "environmental-survey-92c2e.firebaseapp.com",
      projectId: "environmental-survey-92c2e",
      storageBucket: "environmental-survey-92c2e.appspot.com",
      messagingSenderId: "104623922546",
      appId: "1:104623922546:web:4ca46c9599b4b66753e28f",
      measurementId: "G-683FNTR2QB"
    };
    firebase.initializeApp(firebaseConfig);

    // Gets a reference to the Firestore database (already initialized above)
    const db = firebase.firestore();

    const form = document.getElementById("form"); // Questions will be stored in this form container
    const canvas = document.getElementById("resultsChart"); // canvas will hold the charts at the end of the survey
    let currentStep = 0;
    let chartInstance = null;

    const questions = []; // This is the list to manually store the questions

    // First few manually defined
    questions.push({
      key: "q1",
      text: "1. From the ages of 0 to 18 years, what type of community did you grow up in?",
      options: ["Urban", "Suburban", "Rural"]
    });
    questions.push({
      key: "q2",
      text: "2. What was your average household family income from the ages of 0 to 18? Give your best guess",
      options: ["Over $100,000", "$50,000–$100,000", "$0–50,000"]
    });
    questions.push({
      key: "q3",
      text: "3. How often were environmental issues highlighted in your school curriculum?",
      options: ["Frequently", "Sometimes", "Rarely"]
    });

    // Remaining built using loop for variation
    const rest = [
      "How frequently did you or your family try to recycle or reduce waste?",
      "In your household, how often were environmental concerns emphasized?",
      "While growing up, how often did your values/religion/culture influence your environmental perceptions?",
      "In the past two years, how frequently have you engaged in activities relating to the environment?",
      "How frequently do you currently recycle everyday items?",
      "How frequently do you engage or participate in listening to environmental concerns?",
      "How often have you donated or volunteered money or time to environmental concerns in the past two years?",
      "How often do you consider environmental issues when making decisions on who you vote for?",
      "How concerned are you about environmental issues today?"
    ];

    rest.forEach((text, i) => {
      const idx = i + 4;
      const key = `q${idx}`;
      const options = key === "q12"
        ? ["Very Concerned", "Moderately Concerned", "A Little Concerned", "Not Concerned"]
        : ["Frequently", "Sometimes", "Rarely"];
      questions.push({ key, text: `${idx}. ${text}`, options });
    });

    const responses = {};
    let pastScore = 0;
    let presentScore = 0;

    function showStep(index) {
      const steps = document.querySelectorAll(".form-step");
      steps.forEach((step, i) => {
        step.classList.toggle("active", i === index);
      });
      canvas.style.display = "none";
    }

    async function saveToFirebase(responses) {
      const totalScore = pastScore + presentScore;
      await db.collection("surveyResponses").add({
        ...responses,
        pastScore,
        presentScore,
        totalScore,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    async function showAllResults() {
      const snapshot = await db.collection("surveyResponses").get();
      const allResponses = snapshot.docs.map(doc => doc.data());

      const summaryDiv = document.createElement("div");
      summaryDiv.style.display = "grid";
      summaryDiv.style.gridTemplateColumns = "repeat(2, 1fr)";
      summaryDiv.style.gap = "40px";
      summaryDiv.style.padding = "20px";

      questions.forEach((q) => {
        const counts = {};
        q.options.forEach(opt => counts[opt] = 0);

        allResponses.forEach(userResp => {
          const answer = userResp[q.key];
          if (counts[answer] !== undefined) counts[answer]++;
        });

        const container = document.createElement("div");
        container.style.textAlign = "center";

        const title = document.createElement("h3");
        title.innerText = q.text;
        title.style.marginBottom = "12px";
        container.appendChild(title);

        const pieCanvas = document.createElement("canvas");
        pieCanvas.width = 400;
        pieCanvas.height = 400;
        container.appendChild(pieCanvas);

        new Chart(pieCanvas, {
          type: "pie",
          data: {
            labels: Object.keys(counts),
            datasets: [{
              data: Object.values(counts),
              backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0"]
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });

        summaryDiv.appendChild(container);
      });

      const scoreWrapper = document.createElement("div");
      scoreWrapper.style.display = "flex";
      scoreWrapper.style.justifyContent = "center";
      scoreWrapper.style.marginTop = "40px";

      displayScoreSummary(scoreWrapper);
      form.appendChild(scoreWrapper); 
      form.appendChild(summaryDiv); 
    }

    function validateAndStoreAnswer(qKey, index) {
      const selected = form.querySelector(`input[name="${qKey}"]:checked`);
      if (!selected) {
        alert("Please select an option before continuing.");
        return false;
      }
      // This condition separates early life vs. recent environmental behavior scores
      responses[qKey] = selected.value; 
      const value = scoring[selected.value] || 0;
      if (index < 6) pastScore += value;
      else presentScore += value;
      return true;
    }

    function displayScoreSummary(container) {
      const total = pastScore + presentScore;
      const summary = document.createElement("div");
      summary.style.marginTop = "30px";
      summary.style.textAlign = "center";
      summary.style.gridColumn = "1 / -1"; // centers the graph
      summary.innerHTML = `
        <h3>Score Summary</h3>
        <p><strong>Past Score (Q1–Q6):</strong> ${pastScore} / 60</p>
        <p><strong>Present Score (Q7–Q12):</strong> ${presentScore} / 60</p>
        <p><strong>Total Score:</strong> ${total} / 120</p>
      `;
      container.appendChild(summary);
    }

    questions.forEach((q, index) => {
      const stepDiv = document.createElement("div");
      stepDiv.classList.add("form-step");
      if (index === 0) stepDiv.classList.add("active");

      const control = document.createElement("div");
      control.classList.add("form-control");

      const label = document.createElement("label");
      label.textContent = q.text;
      control.appendChild(label);

      q.options.forEach(opt => {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "8px";
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = q.key;
        radio.value = opt;
        const optLabel = document.createElement("label");
        optLabel.appendChild(radio);
        optLabel.append(" " + opt);
        wrapper.appendChild(optLabel);
        control.appendChild(wrapper);
      });

      stepDiv.appendChild(control);

      const nextBtn = document.createElement("button");
      nextBtn.type = "button";
      nextBtn.textContent = index === questions.length - 1 ? "Finish" : "Next";
      nextBtn.addEventListener("click", async () => {
        const isValid = validateAndStoreAnswer(q.key, index);
        if (!isValid) return;
        setTimeout(async () => {
          currentStep++;
          if (currentStep < questions.length) {
            showStep(currentStep);
          } else {
            form.innerHTML = "<h2>Thank you for completing the survey!</h2>";
            await saveToFirebase(responses);
            await showAllResults();
          }
        }, 300);
      });

      stepDiv.appendChild(nextBtn);
      form.appendChild(stepDiv);
    });

    showStep(currentStep);
  </script>
</body>
</html>
